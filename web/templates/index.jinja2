{% extends "base.jinja2" %}

{% block body %}

<style type="text/css">
    html, body, .row {height:100%; width:100%; margin: 0; }
    .container {height:100%;  width:100%;margin: 0}
    .body{
        padding-top:45px;
    }

    .google-wrapper {
        position: relative;
        height:100%;
    }

    #google-map {
        height:100%;
{#        position:absolute;#}
    }
    #google-map-overlay:hover{
        opacity: 1;
    }
    #google-map-overlay {
        pointer-events:none;
        height:100%;
        width:100%;
        padding-top:60px;
        position: absolute;

        opacity: 0.5;
        top: 0px;
        left: 0px;
        z-index: 2;
    }
    .nav {
        height:45px;
        width:100%;
        border-radius:0px;
        border:0px;
        margin-bottom:0px;
        position: absolute;
        z-index: 3;
        background: #ffffff; /* Old browsers */
        background: -moz-linear-gradient(left,  #ffffff 11%, #ffffff 11%, #009db2 11%); /* FF3.6-15 */
        background: -webkit-linear-gradient(left,  #ffffff 11%,#ffffff 11%,#009db2 11%); /* Chrome10-25,Safari5.1-6 */
        background: linear-gradient(to right,  #ffffff 11%,#ffffff 11%,#009db2 11%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#009db2',GradientType=1 ); /* IE6-9 */


    }
    .labels {
      color: white;
      font-family: "Lucida Grande", "Arial", sans-serif;
      font-weight: bold;
      font-size: 10px;
      text-align: center;
      width: 30px;
      white-space: nowrap;

    }
    .markerAnimation{
      -webkit-animation: pulse 5s 0s infinite;
      animation: pulse 5s 0s infinite;
    }
    @-webkit-keyframes pulse {
     40% {
        -webkit-transform: scale(1.5);
        -moz-transform: scale(1.5);
        transform: scale(1.5);
      }

      60% {
        -webkit-transform: scale(1);
        -moz-transform: scale(1);
        transform: scale(1);
      }
    }
    @keyframes pulse {
      40% {
        -webkit-transform: scale(1.5);
        -moz-transform: scale(1.5);
        transform: scale(1.5);
      }

      60% {
        -webkit-transform: scale(1);
        -moz-transform: scale(1);
        transform: scale(1);
      }
    }
</style>

 <body>
<nav class=" navbar navbar-default nav">
    <div class="container-fluid" style="padding-top:7px">
        <div class="row">
            <div class="col-md-1 col-xs-1 col-sm-1 " >
                <img class="img-responsive" style="padding-left: 5px; padding-top:-2px;" src="static/img/Runr_logo.png"/>
            </div>
            <div class="col-md-2 col-xs-2 col-xs-offset-3 col-md-offset-4" style="padding:3px">
                <b style="color:white; font-size:1.5em" id="timerText"></b>
            </div>
            <div class="col-md-2 col-xs-4 col-xs-offset-1 col-md-offset-3">
                <div class="form-group has-feedback ">
                    <i class="glyphicon glyphicon-search form-control-feedback"></i>
                    <input id="runnerSearch" type="text" class="form-control" placeholder="Search by Name, Bib #"/>
                </div>
            </div>
        </div>
    </div>
</nav>
{#<div class="body">#}
{#    <div class="container">#}
{#            <div class="col-md-6" >#}
{#                Hi#}
        {#            <div id="google-map" ></div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#</div>#}
<div class="google-wrapper body">
{#    <div class="row">#}
{#        <div class="col-md-3" style="height:100%">#}
{#            Hi#}
{#    border-color:#007E96; border-width:1px; border-style:solid;#}
        <div id="google-map" ></div>
        <div id="google-map-overlay">
            <div class="container">
                <div class="row">

                    <div style="background-color:#4A4A4A; border-radius:4px; pointer-events: all" class="col-md-2 col-md-offset-0">
                        <img style="width:50px; height:50px;margin:10px; float:left" src="static/img/owl.png"/>
                        <div style="float:left; padding:10px; padding-bottom:0px">
                            <b id="runner_name" style="color:white"></b>
                            </br>
                            <div style="color:white">Age: </div>
                            <div id="runner_weight" style="color:white">Weight: </div>

                        </div>
                        <div style="float:left; padding:10px; color:white">
                            <div style="color:white">Average Speed: </div>
                            <div style="color:white">Projected Finish: </div>
                            <div style="color:white">Projected Time to Finish: </div>

                        </div>
                    </div>
                    <div id="expandedChartView" style="background-color:#4A4A4A; display:none; border-radius:4px; margin-top: 15px; margin-bottom:15px; pointer-events: all;  height:60%; position:absolute; top:10%" class="col-md-8 col-md-offset-3">
                        <div style="padding: 10px; height: 100%">
                            <div id="expandedCarousel"  style="height: 100%" class="carousel slide" data-ride="carousel">


                              <!-- Wrapper for slides -->
                              <div class="carousel-inner" style="height: 100%" role="listbox">
                                <div class="item active" style="height: 100%">
{#                                  <div class="carousel-caption">#}
                                    <div id="expandedPieChart" style="height: 100%"></div>
{#                                  </div>#}
                                </div>
                              </div>

                              <!-- Controls -->
                              <a class="left carousel-control" role="button" data-slide="prev">
                                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                              </a>
                              <a class="right carousel-control" role="button" data-slide="next">
                                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                              </a>
                            </div>
                        </div>
                    </div>
                    <div style="background-color:#4A4A4A; border-radius:4px; pointer-events: all; position: fixed;bottom: 10px;left:15px" class="col-md-2 ">
                        <div style="color:white; text-align: center" id="clusterCount">Total Cluster Count: 550</div>
                        <div style="color:white;padding: 5px; height:175px">
                            <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">


                              <!-- Wrapper for slides -->
                              <div class="carousel-inner" role="listbox">
                                <div class="item active">
{#                                  <div class="carousel-caption">#}
                                    <div id="piechart" style="height: 175px;"></div>
{#                                  </div>#}
                                </div>
                              </div>

                              <!-- Controls -->
                              <a class="left carousel-control" role="button" data-slide="prev">
                                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                              </a>
                              <a class="right carousel-control" role="button" data-slide="next">
                                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                              </a>
                            </div>
                            <div style="float: none; ">
                                <button id="expandChart" style="margin:5px" class="btn btn-default btn-xs pull-right">
                                    <small><span class="glyphicon glyphicon-new-window"></span></small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>
{##}
            {#        <div class="container">#}

{#</div>#}
{#        #}
{#            <div class="col-md-1" style="background-color:#ffffff;">Hi</div>#}
{#        </div>#}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script>
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {

            var data = google.visualization.arrayToDataTable([
              ['Task', 'Hours per Day'],
              ['Work',     11],
              ['Eat',      2],
              ['Commute',  2],
              ['Watch TV', 2],
              ['Sleep',    7]
            ]);

            var options = {
                title: 'My Daily Activities',
                backgroundColor: { fill:'transparent' },
                titleTextStyle: {
                    color: 'white'
                },
                legend: {
                    textStyle: {
                        color: 'white'
                    }
                }
            };

            var chart = new google.visualization.PieChart(document.getElementById('piechart'));
            chart.draw(data, options);

        }
        $('#runnerSearch').bind("enterKey",function(e){
            $.ajax({
                'url':'/search_for_runner',
                'data': {
                    'query':$("#runnerSearch").val()
                },
                success: function(data)
                {
                    runner_object = JSON.parse(data);
                    $("#runner_weight").text("Weight:" + runner_object.weight);
                    $("#runner_name").text(runner_object.given_name);
                }
            })
           //do stuff here
        });
        $('#runnerSearch').keyup(function(e){
            if(e.keyCode == 13)
            {
                $(this).trigger("enterKey");
            }
        });

        $("#expandChart").click(function()
        {
            $("#expandedChartView").toggle();
            if($("#expandedChartView").css("visibility") == "visible") {
                google.charts.setOnLoadCallback(drawExpandedPieChart);
                function drawExpandedPieChart() {

                    var data = google.visualization.arrayToDataTable([
                        ['Task', 'Hours per Day'],
                        ['Work', 11],
                        ['Eat', 2],
                        ['Commute', 2],
                        ['Watch TV', 2],
                        ['Sleep', 7]
                    ]);

                    var options = {
                        title: 'My Daily Activities',
                        backgroundColor: {fill: 'transparent'},
                        titleTextStyle: {
                            color: 'white'
                        },
                        legend: {
                            textStyle: {
                                color: 'white'
                            }
                        }
                    };
                    var expandedChart = new google.visualization.PieChart(document.getElementById('expandedPieChart'));
                    expandedChart.draw(data, options);
                }
            }
        })
        function updateTimer() {
            $.ajax({
                'url': '/get_timer_tick',
                success: function (time) {
                    $("#timerText").text(pad(Math.floor(time / 3600), 2) + ":" + pad(Math.floor((time % 3600) / 60), 2) + ":" + pad(time % 60, 2))

                }
            })
        }
        function pad(n, width) {
            var n = n + '';
            return n.length >= width ? n : new Array(width - n.length + 1).join('0') + n;
        }
        var markers = []
        function initMap() {
            map = new google.maps.Map(document.getElementById('google-map'), {
                zoom: 10,
                minZoom: 10,
                maxZoom: 18,
                center: {lat: 40.621906, lng: -74.032435},
                streetViewControl: false,
                mapTypeControl: false,
            });

            $.ajax({
                url:'/get_route_coordinates',
                success:function(data)
                {

                    polyLineCoordinates = JSON.parse(data);
                    var path = new google.maps.Polyline({
                        path: polyLineCoordinates,
                        geodesic: true,
                        strokeColor: '#009db2',
                        strokeOpacity: 1.0,
                        strokeWeight: 4
                    });

                    path.setMap(map);
                }
            })
            google.maps.event.addListener(map, 'idle', function() {
                $.ajax({
                    url:'/geospatial_search',
                    data:{
                        latitudeStart: map.getBounds().getNorthEast().lat(),
                        longitudeStart: map.getBounds().getSouthWest().lng(),
                        latitudeEnd: map.getBounds().getSouthWest().lat(),
                        longitudeEnd: map.getBounds().getNorthEast().lng(),
                        radius: (Math.pow(2, 10 - map.zoom) * 4) ,
                    },
                    success: function(data)
                    {
                        jsonData = JSON.parse(data)
{#                        $("#timerText").text(pad(Math.floor(jsonData.time / 3600),2) + ":" + pad(Math.floor((jsonData.time % 3600) / 60),2) + ":" + pad(jsonData.time % 60,2))#}
                        clearMarkers();
                        jsonData.clusters.forEach(function(box)
                        {
                            if(box.count > 0) {
                                var countLatLng = {lat: box.latitude, lng: box.longitude};
                                markers.push(new MarkerWithLabel({
                                    position: countLatLng,
                                    map: map,
                                    labelContent: box.count.toString(),
                                    labelAnchor: new google.maps.Point(15, 7),
                                    labelClass: "labels", // the CSS class for the label
                                    labelInBackground: false,
                                    icon: pinSymbol('#383838'),
                                    title: 'clusterCount'
                                  }));
                                google.maps.event.addListener(markers[markers.length - 1], "click", function (e)
                                {
                                    console.log($(this))
                                    $("#clusterCount").text("Total Cluster Count: " + $(this)[0].labelContent)
                                });
                            }
                        });
                    }
                })
            });
        }
        function updateClusterMarkers()
        {
            $.ajax({
                url: '/geospatial_search',
                data: {
                    latitudeStart: map.getBounds().getNorthEast().lat(),
                    longitudeStart: map.getBounds().getSouthWest().lng(),
                    latitudeEnd: map.getBounds().getSouthWest().lat(),
                    longitudeEnd: map.getBounds().getNorthEast().lng(),
                    radius: (Math.pow(2, 10 - map.zoom) * 4),
                },
                success: function (data) {
                    jsonData = JSON.parse(data)
                    var i = 0;
                    jsonData.clusters.forEach(function (box) {

                        if (box.count > 0) {
                            markers[i].labelContent = box.count.toString();
                            markers[i].label.draw()
                            i++;
                        }
                    });
                }
            });
        }
        function clearMarkers()
        {
            for(var i = 0; i < markers.length; i++)
            {
                markers[i].setMap(null)
            }
            markers = []

        }
        function pinSymbol(color) {
          return {
            path:  google.maps.SymbolPath.CIRCLE ,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: '#000',
            strokeWeight: 2,
            scale: 20
          };
        }



        setInterval(updateTimer, 1000)
        setInterval(updateClusterMarkers, 1500)
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuNqpFE8a9dKuIINC91jdzd0IWJ1js-bw&callback=initMap&libraries=geometry"></script>
    <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerwithlabel/src/markerwithlabel.js"></script>
</body>
{% endblock %}
